name: ğŸš€ å‘å¸ƒ WordPress æ’ä»¶

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šå¦‚ v1.1.0ã€v1.2.0-beta.1 ç­‰ç‰ˆæœ¬æ ‡ç­¾

permissions:
  contents: write  # åˆ›å»º Release å’Œä¸Šä¼ èµ„æºæ‰€éœ€æƒé™
  actions: read    # ä¸‹è½½æ„å»ºäº§ç‰©æ‰€éœ€æƒé™

jobs:
  release:
    name: ğŸ“¦ æ„å»ºå¹¶å‘å¸ƒ
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: ğŸ”„ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œä¾¿äºç”Ÿæˆå‘å¸ƒè¯´æ˜
      
      # æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci
      
      # æ­¥éª¤ 4ï¼šæ ¡éªŒç¯å¢ƒå’Œç‰ˆæœ¬ä¸€è‡´æ€§
      - name: ğŸ” æ ¡éªŒç¯å¢ƒ
        run: |
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          echo "Git æ ‡ç­¾: ${{ github.ref_name }}"
          
          # ä» tag æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ 'v' å‰ç¼€ï¼‰
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "æ ‡ç­¾ç‰ˆæœ¬: $TAG_VERSION"
          
          # æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package.json ç‰ˆæœ¬: $PACKAGE_VERSION"
          
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´: tag=$TAG_VERSION, package.json=$PACKAGE_VERSION"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"
      
      # æ­¥éª¤ 5ï¼šæ„å»º WordPress æ’ä»¶åŒ…
      - name: ğŸ“¦ æ„å»ºæ’ä»¶åŒ…
        run: |
          echo "ğŸš€ æ­£åœ¨æ„å»º WordPress æ’ä»¶åŒ…..."
          npm run build
          
          # æ ¡éªŒæ„å»ºè¾“å‡º
          if [ ! -d "build" ]; then
            echo "âŒ æœªæ‰¾åˆ° build ç›®å½•"
            exit 1
          fi
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„ ZIP æ–‡ä»¶
          ZIP_FILE=$(find build -name "*.zip" -type f | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ build ç›®å½•ä¸‹æœªæ‰¾åˆ° ZIP æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ’ä»¶åŒ…å·²æ„å»º: $ZIP_FILE"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          
          # è·å–æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c%s "$ZIP_FILE")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          echo "ğŸ“Š åŒ…ä½“ç§¯: ${FILE_SIZE_MB}MB"
          echo "PACKAGE_SIZE=${FILE_SIZE_MB}MB" >> $GITHUB_ENV
      
      # æ­¥éª¤ 6ï¼šç”Ÿæˆæ ¡éªŒå’Œ
      - name: ğŸ” ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          echo "ğŸ” æ­£åœ¨ç”Ÿæˆæ ¡éªŒå’Œ..."
          cd build
          
          # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
          sha256sum *.zip > checksums.txt
          
          # ç”Ÿæˆ MD5 æ ¡éªŒå’Œ
          md5sum *.zip >> checksums.txt
          
          echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆ:"
          cat checksums.txt
      
      # æ­¥éª¤ 7ï¼šæå–å‘å¸ƒä¿¡æ¯
      - name: ğŸ“‹ æå–å‘å¸ƒä¿¡æ¯
        run: |
          # ä» tag æå–ç‰ˆæœ¬å·
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "RELEASE_VERSION=$TAG_VERSION" >> $GITHUB_ENV
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          if [[ "$TAG_VERSION" == *"beta"* ]] || [[ "$TAG_VERSION" == *"alpha"* ]] || [[ "$TAG_VERSION" == *"rc"* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "ğŸ“‹ è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "ğŸ“‹ è¿™æ˜¯æ­£å¼å‘å¸ƒ"
          fi
          
          # è®¾ç½®å‘å¸ƒåç§°
          echo "RELEASE_NAME=Notion-to-WordPress v$TAG_VERSION" >> $GITHUB_ENV
      
      # æ­¥éª¤ 8ï¼šåˆ›å»º GitHub Release
      - name: ğŸ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ env.IS_PRERELEASE }}
          generate_release_notes: true
          body: |
            ## ğŸš€ Notion-to-WordPress æ’ä»¶å‘å¸ƒ v${{ env.RELEASE_VERSION }}
            
            ### ğŸ“¦ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ env.RELEASE_VERSION }}
            - **åŒ…ä½“ç§¯**: ${{ env.PACKAGE_SIZE }}
            - **å‘å¸ƒç±»å‹**: ${{ env.IS_PRERELEASE == 'true' && 'é¢„å‘å¸ƒ' || 'æ­£å¼å‘å¸ƒ' }}
            
            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸‹æ–¹ `notion-to-wordpress-${{ env.RELEASE_VERSION }}.zip` æ–‡ä»¶
            2. è¿›å…¥ WordPress åå°
            3. ä¾æ¬¡ç‚¹å‡» **æ’ä»¶** â†’ **å®‰è£…æ’ä»¶** â†’ **ä¸Šä¼ æ’ä»¶**
            4. é€‰æ‹©ä¸‹è½½çš„ ZIP æ–‡ä»¶å¹¶ç‚¹å‡» **ç°åœ¨å®‰è£…**
            5. å®‰è£…å®Œæˆåæ¿€æ´»æ’ä»¶
            
            ### ğŸ” å®‰å…¨æ€§
            è¯·ä½¿ç”¨æä¾›çš„æ ¡éªŒå’Œæ–‡ä»¶æ ¡éªŒåŒ…å®Œæ•´æ€§ï¼š
            - ä¸‹è½½ `checksums.txt` æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
            - ä½¿ç”¨ `sha256sum` æˆ– `md5sum` æ ¡éªŒ ZIP æ–‡ä»¶
            
            ### ğŸ“š æ–‡æ¡£
            - [å®‰è£…æŒ‡å—](https://github.com/Frank-Loong/Notion-to-WordPress#installation)
            - [é…ç½®æŒ‡å—](https://github.com/Frank-Loong/Notion-to-WordPress#configuration)
            - [å¸¸è§é—®é¢˜](https://github.com/Frank-Loong/Notion-to-WordPress#troubleshooting)
            
            ### ğŸ› é—®é¢˜ä¸æ”¯æŒ
            å¦‚é‡é—®é¢˜è¯· [æäº¤ issue](https://github.com/Frank-Loong/Notion-to-WordPress/issues) å¹¶é™„è¯¦ç»†ä¿¡æ¯ã€‚
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/Frank-Loong/Notion-to-WordPress/compare/v${{ env.RELEASE_VERSION }}...HEAD
          files: |
            build/*.zip
            build/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤ 9ï¼šå‘å¸ƒåé€šçŸ¥ä¸æ¸…ç†
      - name: ğŸ“¢ å‘å¸ƒåæ“ä½œ
        run: |
          echo "ğŸ‰ v${{ env.RELEASE_VERSION }} å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ åŒ…: notion-to-wordpress-${{ env.RELEASE_VERSION }}.zip"
          echo "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          
          # å¯é€‰ï¼šæ¸…ç†æ„å»ºäº§ç‰©ï¼ˆå»ºè®®ä¿ç•™ä¾¿äºè°ƒè¯•ï¼‰
          # rm -rf build
          
          echo "âœ… å‘å¸ƒæµç¨‹å·²å®Œæˆ!"

  # å¯é€‰ï¼šå¤±è´¥æ—¶é€šçŸ¥
  notify-failure:
    name: ğŸ“§ å¤±è´¥é€šçŸ¥
    runs-on: ubuntu-latest
    needs: release
    if: failure()
    
    steps:
      - name: ğŸ“§ å¤±è´¥é€šçŸ¥
        run: |
          echo "âŒ å‘å¸ƒæµç¨‹å¤±è´¥ï¼Œæ ‡ç­¾ ${{ github.ref_name }}"
          echo "ğŸ” è¯·æ£€æŸ¥ workflow æ—¥å¿—"
          echo "ğŸ”— Workflow åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
