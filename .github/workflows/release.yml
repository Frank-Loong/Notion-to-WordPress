name: ğŸš€ å‘å¸ƒ WordPress æ’ä»¶

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šå¦‚ v1.1.0ã€v1.2.0-beta.1 ç­‰ç‰ˆæœ¬æ ‡ç­¾

permissions:
  contents: write  # åˆ›å»º Release å’Œä¸Šä¼ èµ„æºæ‰€éœ€æƒé™
  actions: read    # ä¸‹è½½æ„å»ºäº§ç‰©æ‰€éœ€æƒé™

jobs:
  release:
    name: ğŸ“¦ æ„å»ºå¹¶å‘å¸ƒ
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: ğŸ”„ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œä¾¿äºç”Ÿæˆå‘å¸ƒè¯´æ˜

      # æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # æ­¥éª¤ 3ï¼šè®¾ç½® PHP ç¯å¢ƒ
      - name: ğŸ˜ è®¾ç½® PHP ç¯å¢ƒ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, json, curl
          coverage: none

      # æ­¥éª¤ 4ï¼šç¼“å­˜ Composer ä¾èµ–
      - name: ğŸ“¦ ç¼“å­˜ Composer ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # æ­¥éª¤ 5ï¼šå®‰è£… Node.js ä¾èµ–
      - name: ğŸ“¥ å®‰è£… Node.js ä¾èµ–
        run: npm ci

      # æ­¥éª¤ 6ï¼šå®‰è£… Composer ä¾èµ–
      - name: ğŸ“¥ å®‰è£… Composer ä¾èµ–
        run: |
          if [ -f composer.lock ]; then
            composer install --no-dev --optimize-autoloader --no-interaction
          else
            echo "âš ï¸ æœªæ‰¾åˆ° composer.lock æ–‡ä»¶ï¼Œè·³è¿‡ Composer ä¾èµ–å®‰è£…"
          fi

      # æ­¥éª¤ 7ï¼šä¾èµ–å®‰å…¨æ‰«æ
      - name: ğŸ”’ ä¾èµ–å®‰å…¨æ‰«æ
        run: |
          echo "ğŸ” æ­£åœ¨è¿›è¡Œä¾èµ–å®‰å…¨æ‰«æ..."

          # npm å®‰å…¨æ‰«æ
          echo "ğŸ“¦ æ‰«æ npm ä¾èµ–..."

          # æ£€æŸ¥ npm audit æ˜¯å¦å¯ç”¨
          if npm audit --help >/dev/null 2>&1; then
            # å°è¯•è¿è¡Œ npm audit
            if npm audit --audit-level=high --omit=dev 2>/dev/null; then
              echo "âœ… npm audit æ‰«æå®Œæˆï¼Œæœªå‘ç°é«˜å±æ¼æ´"
            else
              AUDIT_EXIT_CODE=$?
              if [ $AUDIT_EXIT_CODE -eq 1 ]; then
                echo "âš ï¸ npm audit å‘ç°æ¼æ´ï¼Œä½†ç»§ç»­æ„å»ºï¼ˆä»…è­¦å‘Šï¼‰"
              else
                echo "âš ï¸ npm audit æ‰§è¡Œå¤±è´¥ï¼ˆå¯èƒ½æ˜¯é•œåƒä¸æ”¯æŒï¼‰ï¼Œè·³è¿‡ npm å®‰å…¨æ‰«æ"
              fi
            fi

            # å°è¯•ç”Ÿæˆ JSON æŠ¥å‘Š
            echo "ğŸ“‹ ç”Ÿæˆ npm å®‰å…¨æŠ¥å‘Š..."
            if npm audit --json --omit=dev > npm-audit-report.json 2>/dev/null; then
              echo "âœ… npm å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ"

              # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡æ¼æ´ï¼ˆå¦‚æœ jq å¯ç”¨ï¼‰
              if command -v jq >/dev/null 2>&1; then
                CRITICAL_VULNS=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-report.json 2>/dev/null || echo "0")
                HIGH_VULNS=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-report.json 2>/dev/null || echo "0")
              else
                echo "â„¹ï¸ jq ä¸å¯ç”¨ï¼Œè·³è¿‡æ¼æ´æ•°é‡ç»Ÿè®¡"
                CRITICAL_VULNS="0"
                HIGH_VULNS="0"
              fi
            else
              echo "âš ï¸ æ— æ³•ç”Ÿæˆ npm å®‰å…¨æŠ¥å‘Šï¼ˆå¯èƒ½æ˜¯é•œåƒä¸æ”¯æŒï¼‰ï¼Œåˆ›å»ºç©ºæŠ¥å‘Š"
              echo '{"metadata":{"vulnerabilities":{"critical":0,"high":0}}}' > npm-audit-report.json
              CRITICAL_VULNS="0"
              HIGH_VULNS="0"
            fi
          else
            echo "âš ï¸ npm audit ä¸å¯ç”¨ï¼Œè·³è¿‡ npm å®‰å…¨æ‰«æ"
            echo '{"metadata":{"vulnerabilities":{"critical":0,"high":0}}}' > npm-audit-report.json
            CRITICAL_VULNS="0"
            HIGH_VULNS="0"
          fi

          echo "ğŸ” å®‰å…¨æ‰«æç»“æœ:"
          echo "  ä¸¥é‡æ¼æ´: $CRITICAL_VULNS"
          echo "  é«˜å±æ¼æ´: $HIGH_VULNS"

          # å¦‚æœæœ‰ä¸¥é‡æ¼æ´ï¼Œé˜»æ­¢å‘å¸ƒ
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ å‘ç° $CRITICAL_VULNS ä¸ªä¸¥é‡å®‰å…¨æ¼æ´ï¼Œé˜»æ­¢å‘å¸ƒ"
            echo "è¯·è¿è¡Œ 'npm audit fix' ä¿®å¤æ¼æ´åé‡æ–°å‘å¸ƒ"
            exit 1
          fi

          # å¦‚æœæœ‰è¶…è¿‡5ä¸ªé«˜å±æ¼æ´ï¼Œå‘å‡ºè­¦å‘Šä½†ä¸é˜»æ­¢
          if [ "$HIGH_VULNS" -gt 5 ]; then
            echo "âš ï¸ å‘ç° $HIGH_VULNS ä¸ªé«˜å±æ¼æ´ï¼Œå»ºè®®å°½å¿«ä¿®å¤"
          fi

          # Composer å®‰å…¨æ‰«æï¼ˆå¦‚æœæœ‰ä¾èµ–ï¼‰
          if [ -f composer.lock ] && [ -s composer.lock ]; then
            echo "ğŸ˜ æ‰«æ Composer ä¾èµ–..."

            # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„åŒ…ä¾èµ–
            COMPOSER_PACKAGES=$(composer show --no-dev 2>/dev/null | wc -l || echo "0")

            if [ "$COMPOSER_PACKAGES" -gt 0 ]; then
              # ä½¿ç”¨ composer auditï¼ˆå¦‚æœå¯ç”¨ï¼‰
              if composer audit --help >/dev/null 2>&1; then
                echo "ä½¿ç”¨ composer audit è¿›è¡Œå®‰å…¨æ‰«æ..."
                composer audit --no-dev || {
                  echo "âš ï¸ Composer audit å‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­æ„å»ºï¼ˆä»…è­¦å‘Šï¼‰"
                }
              else
                echo "â„¹ï¸ Composer audit ä¸å¯ç”¨ï¼Œè·³è¿‡ Composer å®‰å…¨æ‰«æ"
              fi
            else
              echo "â„¹ï¸ æœªå‘ç° Composer åŒ…ä¾èµ–ï¼Œè·³è¿‡ Composer å®‰å…¨æ‰«æ"
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ° composer.lock æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡ Composer å®‰å…¨æ‰«æ"
          fi

          echo "âœ… ä¾èµ–å®‰å…¨æ‰«æå®Œæˆ"

      # æ­¥éª¤ 8ï¼šä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      - name: ğŸ“‹ ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿè¦ä¸Šä¼ æŠ¥å‘Š
        with:
          name: security-audit-reports
          path: |
            npm-audit-report.json
          retention-days: 30

      # æ­¥éª¤ 9ï¼šæ ¡éªŒç¯å¢ƒå’Œç‰ˆæœ¬ä¸€è‡´æ€§
      - name: ğŸ” æ ¡éªŒç¯å¢ƒ
        run: |
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          echo "PHP ç‰ˆæœ¬: $(php --version | head -n 1)"
          echo "Composer ç‰ˆæœ¬: $(composer --version)"
          echo "Git æ ‡ç­¾: ${{ github.ref_name }}"

          # ä» tag æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ 'v' å‰ç¼€ï¼‰
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "æ ‡ç­¾ç‰ˆæœ¬: $TAG_VERSION"

          # æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package.json ç‰ˆæœ¬: $PACKAGE_VERSION"

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´: tag=$TAG_VERSION, package.json=$PACKAGE_VERSION"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"
      
      # æ­¥éª¤ 10ï¼šæ„å»º WordPress æ’ä»¶åŒ…
      - name: ğŸ“¦ æ„å»ºæ’ä»¶åŒ…
        id: build_package
        run: |
          echo "ğŸš€ æ­£åœ¨æ„å»º WordPress æ’ä»¶åŒ…..."
          npm run build

          # æ ¡éªŒæ„å»ºè¾“å‡º
          if [ ! -d "build" ]; then
            echo "âŒ æœªæ‰¾åˆ° build ç›®å½•"
            exit 1
          fi

          # æŸ¥æ‰¾ç”Ÿæˆçš„ ZIP æ–‡ä»¶
          ZIP_FILE=$(find build -name "*.zip" -type f | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ build ç›®å½•ä¸‹æœªæ‰¾åˆ° ZIP æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ’ä»¶åŒ…å·²æ„å»º: $ZIP_FILE"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT

          # è·å–æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c%s "$ZIP_FILE")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          echo "ğŸ“Š åŒ…ä½“ç§¯: ${FILE_SIZE_MB}MB"
          PACKAGE_SIZE="${FILE_SIZE_MB}MB"
          echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_ENV
          echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤ 11ï¼šç”Ÿæˆæ ¡éªŒå’Œ
      - name: ğŸ” ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          echo "ğŸ” æ­£åœ¨ç”Ÿæˆæ ¡éªŒå’Œ..."
          cd build
          
          # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
          sha256sum *.zip > checksums.txt
          
          # ç”Ÿæˆ MD5 æ ¡éªŒå’Œ
          md5sum *.zip >> checksums.txt
          
          echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆ:"
          cat checksums.txt
      
      # æ­¥éª¤ 12ï¼šæå–å‘å¸ƒä¿¡æ¯
      - name: ğŸ“‹ æå–å‘å¸ƒä¿¡æ¯
        id: release_info
        run: |
          # ä» tag æå–ç‰ˆæœ¬å·
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "RELEASE_VERSION=$TAG_VERSION" >> $GITHUB_ENV
          echo "release_version=$TAG_VERSION" >> $GITHUB_OUTPUT

          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          if [[ "$TAG_VERSION" == *"beta"* ]] || [[ "$TAG_VERSION" == *"alpha"* ]] || [[ "$TAG_VERSION" == *"rc"* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ This is a pre-release version"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ This is a stable release"
          fi

          # è®¾ç½®å‘å¸ƒåç§°
          RELEASE_NAME="Notion-to-WordPress v$TAG_VERSION"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤ 13ï¼šåˆ›å»º GitHub Release
      - name: ğŸ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.release_info.outputs.release_name }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ steps.release_info.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          body: |
            ## ğŸš€ Notion-to-WordPress Plugin Release v${{ steps.release_info.outputs.release_version }}

            ### ğŸ“¦ Package Information
            - **Version**: ${{ steps.release_info.outputs.release_version }}
            - **Package Size**: ${{ steps.build_package.outputs.package_size }}
            - **Release Type**: ${{ steps.release_info.outputs.is_prerelease == 'true' && 'Pre-release' || 'Stable Release' }}

            ### ğŸ“¥ Installation Instructions
            1. Download the `notion-to-wordpress-${{ steps.release_info.outputs.release_version }}.zip` file below
            2. Go to your WordPress admin dashboard
            3. Navigate to **Plugins** â†’ **Add New** â†’ **Upload Plugin**
            4. Select the downloaded ZIP file and click **Install Now**
            5. Activate the plugin after installation completes

            ### ğŸ” Security & Verification
            Please verify package integrity using the provided checksums:
            - Download `checksums.txt` to verify file integrity
            - Use `sha256sum` or `md5sum` to verify the ZIP file

            ### ğŸ› Issues & Support
            If you encounter any issues, please [create an issue](https://github.com/Frank-Loong/Notion-to-WordPress/issues) with detailed information.

            ---

            **Full Changelog**: https://github.com/Frank-Loong/Notion-to-WordPress/compare/${{ github.event.repository.default_branch }}...v${{ steps.release_info.outputs.release_version }}
          files: |
            build/*.zip
            build/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤ 14ï¼šå‘å¸ƒåé€šçŸ¥ä¸æ¸…ç†
      - name: ğŸ“¢ å‘å¸ƒåæ“ä½œ
        run: |
          echo "ğŸ‰ v${{ steps.release_info.outputs.release_version }} å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ åŒ…: notion-to-wordpress-${{ steps.release_info.outputs.release_version }}.zip"
          echo "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

          # å¯é€‰ï¼šæ¸…ç†æ„å»ºäº§ç‰©ï¼ˆå»ºè®®ä¿ç•™ä¾¿äºè°ƒè¯•ï¼‰
          # rm -rf build

          echo "âœ… å‘å¸ƒæµç¨‹å·²å®Œæˆ!"

  # å¯é€‰ï¼šå¤±è´¥æ—¶é€šçŸ¥
  notify-failure:
    name: ğŸ“§ å¤±è´¥é€šçŸ¥
    runs-on: ubuntu-latest
    needs: release
    if: failure()

    steps:
      - name: ğŸ“§ å¤±è´¥é€šçŸ¥
        run: |
          echo "âŒ å‘å¸ƒæµç¨‹å¤±è´¥ï¼Œæ ‡ç­¾ ${{ github.ref_name }}"
          echo "ğŸ” è¯·æ£€æŸ¥ workflow æ—¥å¿—"
          echo "ğŸ”— Workflow åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"